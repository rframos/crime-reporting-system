<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SafeCity SJDM | Access</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #2c3e50; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .auth-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 400px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="auth-card">
        <h2 class="text-center fw-bold mb-4" id="formTitle">SafeCity Login</h2>
        
        <form id="loginForm">
            <input type="text" name="username" class="form-control mb-3" placeholder="Username" required>
            <input type="password" name="password" class="form-control mb-3" placeholder="Password" required>
            <button type="submit" class="btn btn-primary w-100 mb-3">Login</button>
            <p class="text-center small">No account? <a href="#" onclick="toggleForm()">Register here</a></p>
        </form>

        <form id="registerForm" class="hidden">
            <input type="text" name="username" class="form-control mb-3" placeholder="Choose Username" required>
            <input type="password" name="password" class="form-control mb-3" placeholder="Choose Password" required>
            <select name="role" class="form-select mb-3" required>
                <option value="Resident">Resident</option>
                <option value="Police">Police Officer</option>
                <option value="Admin">Admin</option>
            </select>
            <button type="submit" class="btn btn-success w-100 mb-3">Create Account</button>
            <p class="text-center small">Have an account? <a href="#" onclick="toggleForm()">Login here</a></p>
        </form>
    </div>

    <script>
        function toggleForm() {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
            const title = document.getElementById('formTitle');
            title.innerText = title.innerText === 'SafeCity Login' ? 'SafeCity Register' : 'SafeCity Login';
        }

        // Fix for 400 Error: Ensure all fields are captured
        document.getElementById('registerForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const res = await fetch('/api/register', { method: 'POST', body: formData });
            if(res.ok) {
                alert("Account created! Please login.");
                toggleForm();
            } else {
                const data = await res.json();
                alert("Error: " + (data.message || "Registration Failed"));
            }
        };

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const res = await fetch('/api/login', { method: 'POST', body: new FormData(e.target) });
            if(res.ok) window.location.href = '/';
            else alert("Invalid credentials");
        };
    </script>
</body>
</html>
